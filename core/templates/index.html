<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Contador de Personas en Tiempo Real</title>
    <!-- Estilos CSS simples para una interfaz limpia y moderna -->
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: 40px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1 { color: #333; }
        /* Estilo del recuadro del video */
        #video-feed { 
            width: 100%; 
            max-width: 640px; 
            border: 4px solid #8A2BE2; /* Borde morado vibrante */
            border-radius: 8px; 
            margin: 20px 0; 
            display: block; 
            margin-left: auto; 
            margin-right: auto; 
        }
        /* Estilo del contador grande */
        #counter-display { 
            font-size: 2.5em; 
            font-weight: bold; 
            color: #8A2BE2; 
            margin-top: 20px; 
        }
        .status { color: #555; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Contador de Personas (Detección en Tiempo Real)</h1>
        
        <!-- ELEMENTO DE LA SESIÓN 3: Contador básico -->
        <div id="counter-display">Esperando Stream...</div>
        
        <!-- Aquí se mostrará el stream de video procesado -->
        <img id="video-feed" src="" alt="Video de Detección de Personas" 
            onerror="this.src='data:image/svg+xml;charset=UTF-8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'640\' height=\'480\' viewBox=\'0 0 640 480\'><rect width=\'100%\' height=\'100%\' fill=\'#ccc\'/><text x=\'50%\' y=\'50%\' font-size=\'20\' fill=\'#333\' text-anchor=\'middle\' dominant-baseline=\'middle\'>Cargando Stream de OpenCV...</text></svg>'" />
        
        <div class="status" id="connection-status">Estado: Conectando...</div>
    </div>

    <script>
        // ----------------------------------------------------
        // LÓGICA DE WEBSOCKETS EN JAVASCRIPT
        // ----------------------------------------------------

        // Obtiene el protocolo correcto (ws:// o wss://) y la ruta del host
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsPath = protocol + window.location.host + '/ws/video/';
        
        // Abre la conexión WebSocket
        const socket = new WebSocket(wsPath);
        
        const videoFeed = document.getElementById('video-feed');
        const counterDisplay = document.getElementById('counter-display');
        const statusDisplay = document.getElementById('connection-status');

        // Se ejecuta al recibir datos del servidor
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // Actualiza la imagen con el frame codificado en Base64
            videoFeed.src = 'data:image/jpeg;base64,' + data.image;
            
            // Actualiza el contador
            counterDisplay.textContent = 'Personas Detectadas: ' + data.count;
        };

        // Manejo de estado de conexión
        socket.onopen = function(e) {
            statusDisplay.textContent = 'Estado: Conectado. Procesamiento activo.';
            statusDisplay.style.color = 'green';
        };

        socket.onclose = function(e) {
            statusDisplay.textContent = 'Estado: Desconectado. (Reinicie el servidor)';
            statusDisplay.style.color = 'red';
            console.error('Socket cerrado inesperadamente', e);
        };
    </script>
</body>
</html>